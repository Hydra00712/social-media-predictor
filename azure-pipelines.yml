# Azure DevOps Pipeline for Container Apps Deployment
# Trigger: commits to main branch
trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  azureSubscription: 'Azure-Service-Connection'  # Create this in Project Settings > Service Connections
  resourceGroup: 'rg-social-media-ml'
  location: 'francecentral'
  acrName: 'socialmlacr'
  containerAppName: 'social-ml-app'
  containerAppEnv: 'social-ml-env'
  keyVaultName: 'kv-social-ml-7487'
  imageName: 'social-ml'
  imageTag: '$(Build.BuildId)'

stages:
  - stage: Build
    displayName: 'Build and Push Docker Image'
    jobs:
      - job: BuildJob
        displayName: 'Build Docker Image'
        steps:
          - task: AzureCLI@2
            displayName: 'Azure CLI - Build and Push to ACR'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                echo "Logging into ACR: $(acrName)"
                az acr login --name $(acrName)
                
                echo "Building Docker image..."
                docker build -t $(acrName).azurecr.io/$(imageName):$(imageTag) \
                            -t $(acrName).azurecr.io/$(imageName):latest .
                
                echo "Pushing image to ACR..."
                docker push $(acrName).azurecr.io/$(imageName):$(imageTag)
                docker push $(acrName).azurecr.io/$(imageName):latest
                
                echo "âœ… Image pushed successfully"

  - stage: Deploy
    displayName: 'Deploy to Azure Container Apps'
    dependsOn: Build
    jobs:
      - deployment: DeployJob
        displayName: 'Deploy Container App'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self
                
                - task: AzureCLI@2
                  displayName: 'Get Secrets from Key Vault'
                  inputs:
                    azureSubscription: $(azureSubscription)
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Retrieving secrets from Key Vault..."
                      STORAGE_CONN=$(az keyvault secret show --vault-name $(keyVaultName) \
                        --name AZURE-STORAGE-CONNECTION-STRING --query value -o tsv)
                      
                      APPINSIGHTS_CONN=$(az keyvault secret show --vault-name $(keyVaultName) \
                        --name APPLICATIONINSIGHTS-CONNECTION-STRING --query value -o tsv)
                      
                      echo "##vso[task.setvariable variable=STORAGE_CONN;issecret=true]$STORAGE_CONN"
                      echo "##vso[task.setvariable variable=APPINSIGHTS_CONN;issecret=true]$APPINSIGHTS_CONN"
                      echo "âœ… Secrets retrieved"
                
                - task: AzureCLI@2
                  displayName: 'Deploy to Container Apps'
                  inputs:
                    azureSubscription: $(azureSubscription)
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      IMAGE_FULL=$(acrName).azurecr.io/$(imageName):$(imageTag)
                      ACR_SERVER=$(acrName).azurecr.io
                      
                      echo "Deploying image: $IMAGE_FULL"
                      
                      # Check if Container App exists
                      if az containerapp show -n $(containerAppName) -g $(resourceGroup) &>/dev/null; then
                        echo "Updating existing Container App..."
                        az containerapp update \
                          -n $(containerAppName) -g $(resourceGroup) \
                          --image $IMAGE_FULL \
                          --set-env-vars \
                            AZURE_STORAGE_CONNECTION_STRING=secretref:storage-conn \
                            APPLICATIONINSIGHTS_CONNECTION_STRING=secretref:appinsights-conn \
                          --replace-env-vars \
                            AZURE_STORAGE_CONNECTION_STRING=secretref:storage-conn \
                            APPLICATIONINSIGHTS_CONNECTION_STRING=secretref:appinsights-conn \
                          --revision-suffix $(Build.BuildId)
                      else
                        echo "Creating new Container App..."
                        az containerapp create \
                          -n $(containerAppName) -g $(resourceGroup) \
                          --environment $(containerAppEnv) \
                          --image $IMAGE_FULL \
                          --target-port 8501 --ingress external \
                          --min-replicas 0 --max-replicas 1 \
                          --cpu 0.25 --memory 0.5Gi \
                          --secrets \
                            storage-conn="$(STORAGE_CONN)" \
                            appinsights-conn="$(APPINSIGHTS_CONN)" \
                          --env-vars \
                            AZURE_STORAGE_CONNECTION_STRING=secretref:storage-conn \
                            APPLICATIONINSIGHTS_CONNECTION_STRING=secretref:appinsights-conn \
                          --registry-server $ACR_SERVER \
                          --registry-identity system \
                          --assign-identity system
                      fi
                      
                      echo "âœ… Deployment complete"
                      
                      # Get the app URL
                      APP_URL=$(az containerapp show -n $(containerAppName) -g $(resourceGroup) \
                        --query properties.configuration.ingress.fqdn -o tsv)
                      
                      echo "=========================================="
                      echo "ðŸš€ App deployed successfully!"
                      echo "URL: https://$APP_URL"
                      echo "=========================================="
