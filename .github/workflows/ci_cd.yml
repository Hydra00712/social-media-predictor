name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pandas numpy scikit-learn azure-storage-blob azure-cosmos
    
    - name: Run basic tests
      run: |
        # Basic import tests
        python -c "import pandas; import numpy; import sklearn; print('✓ Dependencies OK')"
        python -c "from src.utils.schema import generate_post_id; print('✓ Schema utils OK')"
        echo "✓ Basic tests passed"
  
  deploy-functions:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Deploy Azure Functions
      run: |
        cd functions
        func azure functionapp publish ${{ secrets.FUNCTION_APP_NAME }} --python
      env:
        AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Logout
      run: az logout

